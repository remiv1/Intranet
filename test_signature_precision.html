<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Signature Haute Précision</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .canvas-container {
            border: 2px solid #ccc;
            display: inline-block;
            background: white;
        }
        #signature-canvas {
            border: 1px solid #ddd;
        }
        .controls {
            margin: 10px 0;
        }
        .data-display {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
    </style>
</head>
<body>
    <h1>Test de Signature Haute Précision</h1>
    
    <div class="canvas-container">
        <canvas id="signature-canvas" width="600" height="200"></canvas>
    </div>
    
    <div class="controls">
        <button class="btn btn-secondary" onclick="clearSignature()">Effacer</button>
        <button class="btn btn-secondary" onclick="undoLastStroke()">Annuler dernier trait</button>
        <button class="btn btn-primary" onclick="generateSVG()">Générer SVG</button>
        <button class="btn btn-success" onclick="showData()">Afficher données</button>
    </div>
    
    <div class="data-display">
        <h3>Données de signature :</h3>
        <pre id="signature-data">Tracez une signature pour voir les données...</pre>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <script>
        let signaturePad;
        let customSignatureData = {
            strokes: [],
            currentStroke: null,
            precision: 0.01
        };
        
        function initializeSignaturePad() {
            const canvas = document.getElementById('signature-canvas');
            
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 1)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 1,
                maxWidth: 3,
                throttle: 0,
                minDistance: 0
            });
            
            setupHighPrecisionCapture(canvas);
        }
        
        function setupHighPrecisionCapture(canvas) {
            let isDrawing = false;
            
            function getCoordinates(event) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                let clientX, clientY;
                if (event.touches && event.touches.length > 0) {
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }
                
                return {
                    x: Math.round((clientX - rect.left) * scaleX * 100) / 100,
                    y: Math.round((clientY - rect.top) * scaleY * 100) / 100,
                    timestamp: performance.now(),
                    pressure: event.pressure || 0.5
                };
            }
            
            function startStroke(event) {
                event.preventDefault();
                isDrawing = true;
                
                const coords = getCoordinates(event);
                customSignatureData.currentStroke = {
                    id: Date.now() + Math.random(),
                    startTime: coords.timestamp,
                    points: [coords]
                };
            }
            
            function addPoint(event) {
                if (!isDrawing || !customSignatureData.currentStroke) return;
                
                event.preventDefault();
                const coords = getCoordinates(event);
                customSignatureData.currentStroke.points.push(coords);
            }
            
            function endStroke(event) {
                if (!isDrawing || !customSignatureData.currentStroke) return;
                
                event.preventDefault();
                isDrawing = false;
                
                const coords = getCoordinates(event);
                customSignatureData.currentStroke.points.push(coords);
                customSignatureData.currentStroke.endTime = coords.timestamp;
                
                customSignatureData.strokes.push(customSignatureData.currentStroke);
                customSignatureData.currentStroke = null;
                
                updateDataDisplay();
            }
            
            canvas.addEventListener('mousedown', startStroke);
            canvas.addEventListener('mousemove', addPoint);
            canvas.addEventListener('mouseup', endStroke);
            canvas.addEventListener('mouseleave', endStroke);
            
            canvas.addEventListener('touchstart', startStroke);
            canvas.addEventListener('touchmove', addPoint);
            canvas.addEventListener('touchend', endStroke);
            canvas.addEventListener('touchcancel', endStroke);
        }
        
        function generateSVGFromStrokes(strokes) {
            if (!strokes || strokes.length === 0) return '';
            
            const canvas = document.getElementById('signature-canvas');
            const width = canvas.width;
            const height = canvas.height;
            
            let svgPaths = '';
            
            strokes.forEach(stroke => {
                if (stroke.points.length < 2) return;
                
                let pathData = `M ${stroke.points[0].x} ${stroke.points[0].y}`;
                
                for (let i = 1; i < stroke.points.length; i++) {
                    pathData += ` L ${stroke.points[i].x} ${stroke.points[i].y}`;
                }
                
                svgPaths += `<path d="${pathData}" stroke="black" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`;
            });
            
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
                ${svgPaths}
            </svg>`;
            
            return svg;
        }
        
        function clearSignature() {
            signaturePad.clear();
            customSignatureData = {
                strokes: [],
                currentStroke: null,
                precision: 0.01
            };
            updateDataDisplay();
        }
        
        function undoLastStroke() {
            if (customSignatureData.strokes.length > 0) {
                customSignatureData.strokes.pop();
                redrawSignaturePad();
                updateDataDisplay();
            }
        }
        
        function redrawSignaturePad() {
            if (!signaturePad) return;
            
            signaturePad.clear();
            
            customSignatureData.strokes.forEach(stroke => {
                if (stroke.points.length > 0) {
                    const ctx = signaturePad._ctx;
                    ctx.beginPath();
                    ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
                    
                    for (let i = 1; i < stroke.points.length; i++) {
                        ctx.lineTo(stroke.points[i].x, stroke.points[i].y);
                    }
                    
                    ctx.strokeStyle = 'rgb(0, 0, 0)';
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.stroke();
                }
            });
        }
        
        function generateSVG() {
            const svg = generateSVGFromStrokes(customSignatureData.strokes);
            console.log('SVG généré:', svg);
            
            // Créer un blob et un lien pour télécharger le SVG
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'signature.svg';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function showData() {
            const canvas = document.getElementById('signature-canvas');
            const dataURL = signaturePad.toDataURL();
            const hash = CryptoJS.SHA256(dataURL).toString();
            
            const data = {
                signature_hash: hash,
                user_agent: navigator.userAgent,
                svg_graph: generateSVGFromStrokes(customSignatureData.strokes),
                data_graph: JSON.stringify(customSignatureData),
                largeur_graph: canvas.width,
                hauteur_graph: canvas.height,
                totalStrokes: customSignatureData.strokes.length,
                totalPoints: customSignatureData.strokes.reduce((acc, stroke) => acc + stroke.points.length, 0)
            };
            
            console.log('Données complètes:', data);
            updateDataDisplay();
        }
        
        function updateDataDisplay() {
            const display = document.getElementById('signature-data');
            const totalPoints = customSignatureData.strokes.reduce((acc, stroke) => acc + stroke.points.length, 0);
            
            display.textContent = `Traits: ${customSignatureData.strokes.length}
Points total: ${totalPoints}
Précision: ${customSignatureData.precision} pixels

Derniers points:
${customSignatureData.strokes.slice(-1).map(stroke => 
    stroke.points.slice(-3).map(point => 
        `(${point.x}, ${point.y})`
    ).join(', ')
).join('')}`;
        }
        
        // Initialiser au chargement
        window.addEventListener('load', initializeSignaturePad);
    </script>
</body>
</html>